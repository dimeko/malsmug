FROM ghcr.io/puppeteer/puppeteer:latest AS installer
# puppeteer:24.4.0

WORKDIR /js_dast
COPY dast/package.json dast/tsconfig.json ./

RUN mkdir samples
RUN mkdir default
COPY dast/default_samples/default.js ./default/default.js

RUN npm install
RUN mkdir browsers 
RUN npx puppeteer browsers install chrome --path ./browsers

FROM ghcr.io/puppeteer/puppeteer:latest AS release

WORKDIR /js_dast
COPY --from=installer /js_dast /js_dast

USER root
RUN useradd dast
COPY docker/js_dast_entrypoint.sh /js_dast_entrypoint.sh 
RUN chmod +x /js_dast_entrypoint.sh 

RUN apt-get update \
    && apt-get install -y --no-install-recommends fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-khmeros \
    fonts-kacst fonts-freefont-ttf dbus dbus-x11

ENV DBUS_SESSION_BUS_ADDRESS=autolaunch:
# ENV XDG_CONFIG_HOME=/tmp/.chromium
# ENV XDG_CACHE_HOME=/tmp/.chromium

COPY dast/src/ ./src/
RUN npm run build

ENTRYPOINT ["/js_dast_entrypoint.sh"]
CMD ["./default/default.js"]